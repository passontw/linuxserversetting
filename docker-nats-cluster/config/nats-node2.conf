# =================================================================
# NATS JetStream Cluster - Node 2 Configuration
# =================================================================

# 服務器基本配置
server_name: "nats-node2"
host: "0.0.0.0"
port: 4222

# =================================================================
# Cluster Configuration (集群配置)
# =================================================================
cluster {
    name: "nats-jetstream-cluster"
    host: "0.0.0.0"
    port: 6222
    
    # 集群路由配置
    routes: [
        "nats://nats-node1:6222"
        "nats://nats-node2:6222"  
        "nats://nats-node3:6222"
    ]
    
    # 集群認證 (可選，增強安全性)
    authorization {
        user: "cluster_user"
        password: "cluster_pass_123"
        timeout: 2
    }
}

# =================================================================
# JetStream Configuration (每節點 4GB 儲存)
# =================================================================
jetstream {
    # 儲存目錄
    store_dir: "/data/jetstream"
    
    # 儲存限制 (4GB per node as requested)
    max_memory_store: 4GB      # 記憶體存儲限制 (升級至 4GB)
    max_file_store: 16GB       # 檔案存儲限制 (升級至 16GB)
    
    # 集群複製設定
    domain: "nats-cluster"
    
    # 其他限制
    max_outstanding_catchup: 16MB
}

# =================================================================
# Account Configuration (引入 accounts.conf)
# =================================================================
include "./accounts.conf"

# =================================================================
# HTTP Monitoring (Port 8222)
# =================================================================
http_port: 8222
https_port: 0

# Monitoring 相關設定
server_tags: [
    "node:2",
    "region:secondary", 
    "environment:cluster"
]

# =================================================================
# Prometheus Metrics (啟用 Prometheus 監控)
# =================================================================
# 在 HTTP monitoring 端點提供 Prometheus 格式的 metrics
# 訪問路徑: http://localhost:8223/metrics
# 包含以下指標：
# - gnatsd_connz_* (連接統計)
# - gnatsd_routez_* (路由統計)  
# - gnatsd_subsz_* (訂閱統計)
# - gnatsd_varz_* (變數統計)
# - gnatsd_jsz_* (JetStream 統計)

# =================================================================
# Connection Limits (全局連接限制)
# =================================================================
max_connections: 1000
max_control_line: 4096
max_payload: 16777216        # 16MB (較大的訊息支援)
max_pending: 33554432        # 32MB

# Write deadline for client connections
write_deadline: "10s"

# =================================================================
# Logging Configuration
# =================================================================
log_file: "/data/logs/nats-node2.log"
logtime: true
debug: false
trace: false
log_size_limit: 100MB
max_traced_msg_len: 4096

# =================================================================
# TLS Configuration (目前禁用，TLS 設定參考見 README.md)
# =================================================================
# tls {
#     cert_file: "/etc/nats/certs/server.crt"
#     key_file: "/etc/nats/certs/server.key" 
#     ca_file: "/etc/nats/certs/ca.crt"
#     verify: true
#     timeout: 5
# }

# =================================================================
# System Events (系統事件追蹤)
# =================================================================
system_account: "SYS"

# =================================================================
# Health Check Endpoint
# =================================================================
# Health check 可通過以下端點訪問:
# http://localhost:8223/healthz
# 
# 回應格式:
# - 200 OK: 服務健康
# - 503 Service Unavailable: 服務不可用
# 
# 詳細健康資訊:
# http://localhost:8223/varz    # 伺服器變數
# http://localhost:8223/connz   # 連接資訊  
# http://localhost:8223/routez  # 路由資訊
# http://localhost:8223/subsz   # 訂閱資訊
# http://localhost:8223/jsz     # JetStream 資訊
# ================================================================= 